{% extends 'base.html' %}

{% block content %}
    <h1 class="text-3xl font-bold mb-4">{% block title %}AI Assistant{% endblock %}</h1>
    
    <div class="bg-white p-4 rounded border mb-6">
        <div id="chat-container" class="border rounded p-4 mb-4 h-80 overflow-y-auto">
            <div class="mb-4">
                <div class="font-bold text-blue-600">AI Assistant</div>
                <div class="bg-blue-100 rounded-lg p-3 text-gray-800">
                    Hello! I'm your AI assistant. How can I help you today?
                </div>
            </div>
            <div id="chat-messages"></div>
        </div>
        
        <div class="flex">
            <input type="text" id="user-input" placeholder="Type your message here..." 
                   class="border rounded-l py-2 px-4 flex-grow focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="send-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r">
                Send
            </button>
        </div>
        <div id="loading-indicator" class="hidden mt-2 text-sm text-gray-500">
            AI is thinking...
        </div>
    </div>
    
    <div class="mt-6">
        <a href="{{ url_for('main.home') }}" class="inline-block bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
            Back to Home
        </a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const chatContainer = document.getElementById('chat-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            function addMessage(sender, text, isAi = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'mb-4';
                
                const senderDiv = document.createElement('div');
                senderDiv.className = isAi ? 'font-bold text-blue-600' : 'font-bold text-green-600';
                senderDiv.textContent = sender;
                
                const textDiv = document.createElement('div');
                textDiv.className = isAi ? 'bg-blue-100 rounded-lg p-3 text-gray-800' : 'bg-green-100 rounded-lg p-3 text-gray-800';
                textDiv.textContent = text;
                
                messageDiv.appendChild(senderDiv);
                messageDiv.appendChild(textDiv);
                
                chatMessages.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            async function handleUserInput() {
                const userText = userInput.value.trim();
                if (!userText) return;
                
                // Add user message to chat
                addMessage('You', userText);
                
                // Clear input field
                userInput.value = '';
                
                // Show loading indicator
                loadingIndicator.classList.remove('hidden');
                sendBtn.disabled = true;
                
                try {
                    // Call the backend API
                    const response = await fetch('/chatbot/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query: userText })
                    });
                    
                    const data = await response.json();
                    
                    // Add bot response
                    addMessage('AI Assistant', data.response, true);
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('AI Assistant', 'Sorry, there was an error processing your request.', true);
                } finally {
                    // Hide loading indicator
                    loadingIndicator.classList.add('hidden');
                    sendBtn.disabled = false;
                    // Focus input field
                    userInput.focus();
                }
            }
            
            // Event listeners
            sendBtn.addEventListener('click', handleUserInput);
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleUserInput();
                }
            });
            
            // Focus input field on load
            userInput.focus();
        });
    </script>
{% endblock %}